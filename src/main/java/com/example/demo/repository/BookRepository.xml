<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.BookRepository">
	
	<!-- 書籍一覧表示 -->
	<select id="selectBookDataIdAsc" resultType="com.example.demo.model.BookDto">
		select
			id,
			title,
			author,
			detail,
			publiser,
			publiser_year,
			to_char(purchase_date, 'yyyy-mm-dd') as purchaseDate,
			category,
			status
			from book
	</select>
	
	<!-- 画像一覧表示 -->
	<select id="selectImageBase64byAsc">
		select regexp_replace(
			encode(book_image, 'base64'),E'[\\n\\r]', '', 'g'
		)
		from book
	</select>
	
	<!-- 新規登録 -->
	<insert id="insertBookData">
		insert into book (
			title,
			author,
			publiser, 
			publiser_year,
			detail,
			purchase_date,
			category,
			book_image,
			created_at,
			update_at,
			status,
			borrow_date,
			username,
			address
		) values (
			#{title},
			#{author},
			#{publiser}, 
			#{publiserYear},
			#{detail},
			cast(#{purchaseDate} as timestamp),
			#{category},
			#{bookImage},
			#{createdAt},
			#{updateAt},
			1,
			#{borrowDate},
			#{username},
			#{address}
		)
	</insert>
	
	<!-- 貸出処理 -->
	<update id="updateStatusToBorrowed">
		update book set
			status = 0,
			borrow_date = cast(#{borrowDate} as timestamp),
			username = #{username},
			address = #{address}
			where id= #{id}
	</update>
	
	<!-- 返却処理 -->
	<update id="updateStatusToReturned">
		update book set
			status = 1,
			borrow_date = null,
			username = null,
			address = null
			where id= #{id}
	</update>
	
	<!-- 登録更新 -->
	<update id="updateBookData">
		update book set
			title = #{title},
			author = #{author},
			publiser = #{publiser}, 
			publiser_year = #{publiserYear},
			detail = #{detail},
			purchase_date = cast(#{purchaseDate} as timestamp),
			category = #{category},
			<!-- 画像がnullの場合は画像更新無効 -->
			<if test="bookImage != null">
				book_image = #{bookImage},
			</if>
			update_at = #{updateAt}
			where id= #{id}
	</update>
	
	<!-- 書籍IDから書籍情報を取得 -->
	<select id="selectTargetBookData">
		select
			title,
			author,
			detail,
			publiser,
			publiser_year,
			to_char(purchase_date, 'yyyy-mm-dd') as purchaseDate,
			category,
			status,
			borrow_date,
			username,
			address
			from book where id = #{id}
	</select>
	
	<!-- 書籍IDから画像取得 -->
	<select id="findImageBase64ById">
		select regexp_replace(
			encode(book_image, 'base64'),E'[\\n\\r]', '', 'g'
		)
		from book where id = #{id}
	</select>
</mapper>